import { describe, expect, test } from "@jest/globals";
import { buildDataSchema } from "@mo36924/graphql-mysql-data-schema";
import { retry } from "@mo36924/util";
import { emptyPort, exec } from "@mo36924/util-node";
import { raw } from "jest-snapshot-serializer-raw";
import { createConnection } from "mysql2/promise";
import { buildData } from "./index";

describe("graphql-mysql-data", () => {
  const graphql = `
    type User {
      name: String!
      profile: Profile
      class: Class!
      clubs: [Club!]!
    }
    type Profile {
      age: Int
    }
    type Class {
      name: String!
      users: [User!]!
    }
    type Club {
      name: String!
      users: [User!]!
    }
  `;

  test("buildData", () => {
    const dml = buildData(graphql);

    expect(raw(dml)).toMatchInlineSnapshot(`
      set foreign_key_checks=0;
      insert into \`Class\` (\`id\`,\`version\`,\`createdAt\`,\`updatedAt\`,\`isDeleted\`,\`name\`) values 
      (uuid_to_bin('00000000-0000-4000-a000-000000000001'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-1'),
      (uuid_to_bin('00000000-0000-4000-a000-000000000002'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-2'),
      (uuid_to_bin('00000000-0000-4000-a000-000000000003'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-3');
      insert into \`Club\` (\`id\`,\`version\`,\`createdAt\`,\`updatedAt\`,\`isDeleted\`,\`name\`) values 
      (uuid_to_bin('00000000-0000-4000-a000-000100000001'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-1'),
      (uuid_to_bin('00000000-0000-4000-a000-000100000002'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-2'),
      (uuid_to_bin('00000000-0000-4000-a000-000100000003'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,'name-3');
      insert into \`ClubToUser\` (\`id\`,\`clubId\`,\`userId\`) values 
      (uuid_to_bin('00000000-0000-4000-a000-000200000001'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000001')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000002'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000002')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000003'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000003')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000004'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000004')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000005'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000005')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000006'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000006')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000007'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000007')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000008'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000008')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000009'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000009')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000010'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000001')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000011'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000002')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000012'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000003')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000013'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000004')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000014'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000005')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000015'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000006')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000016'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000007')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000017'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000008')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000018'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000009')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000019'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000001')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000020'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000002')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000021'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000003')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000022'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000004')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000023'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000005')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000024'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000006')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000025'),uuid_to_bin('00000000-0000-4000-a000-000100000001'),uuid_to_bin('00000000-0000-4000-a000-000400000007')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000026'),uuid_to_bin('00000000-0000-4000-a000-000100000002'),uuid_to_bin('00000000-0000-4000-a000-000400000008')),
      (uuid_to_bin('00000000-0000-4000-a000-000200000027'),uuid_to_bin('00000000-0000-4000-a000-000100000003'),uuid_to_bin('00000000-0000-4000-a000-000400000009'));
      insert into \`Profile\` (\`id\`,\`version\`,\`createdAt\`,\`updatedAt\`,\`isDeleted\`,\`age\`,\`userId\`) values 
      (uuid_to_bin('00000000-0000-4000-a000-000300000001'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000001')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000002'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000002')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000003'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000003')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000004'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000004')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000005'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000005')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000006'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000006')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000007'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000007')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000008'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000008')),
      (uuid_to_bin('00000000-0000-4000-a000-000300000009'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,0,uuid_to_bin('00000000-0000-4000-a000-000400000009'));
      insert into \`User\` (\`id\`,\`version\`,\`createdAt\`,\`updatedAt\`,\`isDeleted\`,\`classId\`,\`name\`) values 
      (uuid_to_bin('00000000-0000-4000-a000-000400000001'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000001'),'name-1'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000002'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000002'),'name-2'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000003'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000003'),'name-3'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000004'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000001'),'name-4'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000005'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000002'),'name-5'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000006'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000003'),'name-6'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000007'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000001'),'name-7'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000008'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000002'),'name-8'),
      (uuid_to_bin('00000000-0000-4000-a000-000400000009'),1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',false,uuid_to_bin('00000000-0000-4000-a000-000000000003'),'name-9');
      set foreign_key_checks=1;

    `);
  });

  test("insert data", async () => {
    const ddl = buildDataSchema(graphql);
    const dml = buildData(graphql);
    const database = "graphql_mysql_data";
    const port = await emptyPort();
    await exec(`docker rm -fv ${database}`);

    await exec(
      `docker run --name ${database} -e MYSQL_ALLOW_EMPTY_PASSWORD=yes -e MYSQL_DATABASE=${database} -p ${port}:3306 -d mysql`,
    );

    const connection = await retry(async () => {
      const connection = await createConnection({ port, database, user: "root", multipleStatements: true });
      await connection.connect();
      return connection;
    });

    await connection.query(ddl + dml);
    await connection.end();
  });
});
