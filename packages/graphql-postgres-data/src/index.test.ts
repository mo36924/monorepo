import { describe, expect, test } from "@jest/globals";
import { buildDataSchema } from "@mo36924/graphql-postgres-data-schema";
import { retry } from "@mo36924/util";
import { emptyPort, exec } from "@mo36924/util-node";
import { raw } from "jest-snapshot-serializer-raw";
import { Client } from "pg";
import { buildData } from "./index";

describe("graphql-postgres-data", () => {
  const graphql = `
    type User {
      name: String!
      profile: Profile
      class: Class!
      clubs: [Club!]!
    }
    type Profile {
      age: Int
    }
    type Class {
      name: String!
      users: [User!]!
    }
    type Club {
      name: String!
      users: [User!]!
    }
  `;

  test("buildData", () => {
    const sql = buildData(graphql);

    expect(raw(sql)).toMatchInlineSnapshot(`
      alter table "Class" disable trigger all;
      alter table "Club" disable trigger all;
      alter table "ClubToUser" disable trigger all;
      alter table "Profile" disable trigger all;
      alter table "User" disable trigger all;
      insert into "Class" ("id","version","createdAt","updatedAt","isDeleted","name") values 
      ('00000000-0000-4000-a000-000000000001',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-1'),
      ('00000000-0000-4000-a000-000000000002',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-2'),
      ('00000000-0000-4000-a000-000000000003',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-3');
      insert into "Club" ("id","version","createdAt","updatedAt","isDeleted","name") values 
      ('00000000-0000-4000-a000-000100000001',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-1'),
      ('00000000-0000-4000-a000-000100000002',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-2'),
      ('00000000-0000-4000-a000-000100000003',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'name-3');
      insert into "ClubToUser" ("id","clubId","userId") values 
      ('00000000-0000-4000-a000-000200000001','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000001'),
      ('00000000-0000-4000-a000-000200000002','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000002'),
      ('00000000-0000-4000-a000-000200000003','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000003'),
      ('00000000-0000-4000-a000-000200000004','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000004'),
      ('00000000-0000-4000-a000-000200000005','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000005'),
      ('00000000-0000-4000-a000-000200000006','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000006'),
      ('00000000-0000-4000-a000-000200000007','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000007'),
      ('00000000-0000-4000-a000-000200000008','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000008'),
      ('00000000-0000-4000-a000-000200000009','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000009'),
      ('00000000-0000-4000-a000-000200000010','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000001'),
      ('00000000-0000-4000-a000-000200000011','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000002'),
      ('00000000-0000-4000-a000-000200000012','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000003'),
      ('00000000-0000-4000-a000-000200000013','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000004'),
      ('00000000-0000-4000-a000-000200000014','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000005'),
      ('00000000-0000-4000-a000-000200000015','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000006'),
      ('00000000-0000-4000-a000-000200000016','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000007'),
      ('00000000-0000-4000-a000-000200000017','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000008'),
      ('00000000-0000-4000-a000-000200000018','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000009'),
      ('00000000-0000-4000-a000-000200000019','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000001'),
      ('00000000-0000-4000-a000-000200000020','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000002'),
      ('00000000-0000-4000-a000-000200000021','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000003'),
      ('00000000-0000-4000-a000-000200000022','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000004'),
      ('00000000-0000-4000-a000-000200000023','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000005'),
      ('00000000-0000-4000-a000-000200000024','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000006'),
      ('00000000-0000-4000-a000-000200000025','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000400000007'),
      ('00000000-0000-4000-a000-000200000026','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000400000008'),
      ('00000000-0000-4000-a000-000200000027','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000400000009');
      insert into "Profile" ("id","version","createdAt","updatedAt","isDeleted","age","userId") values 
      ('00000000-0000-4000-a000-000300000001',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000001'),
      ('00000000-0000-4000-a000-000300000002',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000002'),
      ('00000000-0000-4000-a000-000300000003',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000003'),
      ('00000000-0000-4000-a000-000300000004',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000004'),
      ('00000000-0000-4000-a000-000300000005',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000005'),
      ('00000000-0000-4000-a000-000300000006',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000006'),
      ('00000000-0000-4000-a000-000300000007',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000007'),
      ('00000000-0000-4000-a000-000300000008',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000008'),
      ('00000000-0000-4000-a000-000300000009',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,0,'00000000-0000-4000-a000-000400000009');
      insert into "User" ("id","version","createdAt","updatedAt","isDeleted","classId","name") values 
      ('00000000-0000-4000-a000-000400000001',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000001','name-1'),
      ('00000000-0000-4000-a000-000400000002',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000002','name-2'),
      ('00000000-0000-4000-a000-000400000003',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000003','name-3'),
      ('00000000-0000-4000-a000-000400000004',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000001','name-4'),
      ('00000000-0000-4000-a000-000400000005',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000002','name-5'),
      ('00000000-0000-4000-a000-000400000006',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000003','name-6'),
      ('00000000-0000-4000-a000-000400000007',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000001','name-7'),
      ('00000000-0000-4000-a000-000400000008',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000002','name-8'),
      ('00000000-0000-4000-a000-000400000009',1,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',FALSE,'00000000-0000-4000-a000-000000000003','name-9');
      alter table "Class" enable trigger all;
      alter table "Club" enable trigger all;
      alter table "ClubToUser" enable trigger all;
      alter table "Profile" enable trigger all;
      alter table "User" enable trigger all;

    `);
  });

  test("insert data", async () => {
    const ddl = buildDataSchema(graphql);
    const dml = buildData(graphql);
    const database = "graphql_postgres_data";
    const port = await emptyPort();
    await exec(`docker rm -fv ${database}`);

    await exec(
      `docker run --name ${database} -e POSTGRES_PASSWORD=${database} -e POSTGRES_USER=${database} -e POSTGRES_DB=${database} -p ${port}:5432 -d postgres`,
    );

    const connection = await retry(async () => {
      const connection = new Client({ port, database, user: database, password: database });
      await connection.connect();
      return connection;
    });

    await connection.query(ddl + dml);
    await connection.end();
  });
});
