import { expect, test } from "@jest/globals";
import buildSchema from "@mo36924/graphql-postgres-schema";
import { raw } from "@mo36924/jest-snapshot-serializer-raw";
import pg from "pg";
import buildData from "./index";

const model = /* GraphQL */ `
  type User {
    name: String!
    profile: Profile
    class: Class!
    clubs: [Club!]!
  }
  type Profile {
    age: Int
  }
  type Class {
    name: String!
    users: [User!]!
  }
  type Club {
    name: String!
    users: [User!]!
  }
`;

test("graphql-postgres-data", async () => {
  const database = "graphql_postgres_data";
  const sql = buildSchema(model) + buildData(model);
  let client = new pg.Client({ user: "postgres", password: "postgres" });
  await client.connect();
  await client.query(`drop database if exists ${database};`);
  await client.query(`create database ${database};`);
  await client.end();
  client = new pg.Client({ user: "postgres", password: "postgres", database });
  await client.connect();
  await client.query(sql);
  await client.end();

  expect(raw(sql)).toMatchInlineSnapshot(`
    create table "Class" (
      "id" uuid not null primary key,
      "version" integer not null,
      "createdAt" timestamp(3) not null,
      "updatedAt" timestamp(3) not null,
      "name" text not null
    );
    create table "Club" (
      "id" uuid not null primary key,
      "version" integer not null,
      "createdAt" timestamp(3) not null,
      "updatedAt" timestamp(3) not null,
      "name" text not null
    );
    create table "Profile" (
      "id" uuid not null primary key,
      "version" integer not null,
      "createdAt" timestamp(3) not null,
      "updatedAt" timestamp(3) not null,
      "age" integer,
      "userId" uuid
    );
    create table "User" (
      "id" uuid not null primary key,
      "version" integer not null,
      "createdAt" timestamp(3) not null,
      "updatedAt" timestamp(3) not null,
      "classId" uuid,
      "name" text not null
    );
    create table "ClubToUser" (
      "id" uuid not null primary key,
      "version" integer not null,
      "createdAt" timestamp(3) not null,
      "updatedAt" timestamp(3) not null,
      "clubId" uuid not null,
      "userId" uuid not null
    );
    alter table "Profile" add unique ("userId");
    create index on "User" ("classId");
    create index on "ClubToUser" ("clubId");
    create index on "ClubToUser" ("userId");
    insert into "Class" ("id","version","createdAt","updatedAt","name") values 
    ('00000000-0000-4000-a000-000000000001',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-1'),
    ('00000000-0000-4000-a000-000000000002',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-2'),
    ('00000000-0000-4000-a000-000000000003',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-3');
    insert into "Club" ("id","version","createdAt","updatedAt","name") values 
    ('00000000-0000-4000-a000-000100000001',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-1'),
    ('00000000-0000-4000-a000-000100000002',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-2'),
    ('00000000-0000-4000-a000-000100000003',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','name-3');
    insert into "Profile" ("id","version","createdAt","updatedAt","age","userId") values 
    ('00000000-0000-4000-a000-000200000001',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000001'),
    ('00000000-0000-4000-a000-000200000002',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000002'),
    ('00000000-0000-4000-a000-000200000003',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000003'),
    ('00000000-0000-4000-a000-000200000004',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000004'),
    ('00000000-0000-4000-a000-000200000005',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000005'),
    ('00000000-0000-4000-a000-000200000006',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000006'),
    ('00000000-0000-4000-a000-000200000007',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000007'),
    ('00000000-0000-4000-a000-000200000008',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000008'),
    ('00000000-0000-4000-a000-000200000009',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000',0,'00000000-0000-4000-a000-000300000009');
    insert into "User" ("id","version","createdAt","updatedAt","classId","name") values 
    ('00000000-0000-4000-a000-000300000001',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000001','name-1'),
    ('00000000-0000-4000-a000-000300000002',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000002','name-2'),
    ('00000000-0000-4000-a000-000300000003',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000003','name-3'),
    ('00000000-0000-4000-a000-000300000004',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000001','name-4'),
    ('00000000-0000-4000-a000-000300000005',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000002','name-5'),
    ('00000000-0000-4000-a000-000300000006',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000003','name-6'),
    ('00000000-0000-4000-a000-000300000007',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000001','name-7'),
    ('00000000-0000-4000-a000-000300000008',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000002','name-8'),
    ('00000000-0000-4000-a000-000300000009',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000000000003','name-9');
    insert into "ClubToUser" ("id","version","createdAt","updatedAt","clubId","userId") values 
    ('00000000-0000-4000-a000-000400000001',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000001'),
    ('00000000-0000-4000-a000-000400000002',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000002'),
    ('00000000-0000-4000-a000-000400000003',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000003'),
    ('00000000-0000-4000-a000-000400000004',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000004'),
    ('00000000-0000-4000-a000-000400000005',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000005'),
    ('00000000-0000-4000-a000-000400000006',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000006'),
    ('00000000-0000-4000-a000-000400000007',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000007'),
    ('00000000-0000-4000-a000-000400000008',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000008'),
    ('00000000-0000-4000-a000-000400000009',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000009'),
    ('00000000-0000-4000-a000-000400000010',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000001'),
    ('00000000-0000-4000-a000-000400000011',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000002'),
    ('00000000-0000-4000-a000-000400000012',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000003'),
    ('00000000-0000-4000-a000-000400000013',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000004'),
    ('00000000-0000-4000-a000-000400000014',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000005'),
    ('00000000-0000-4000-a000-000400000015',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000006'),
    ('00000000-0000-4000-a000-000400000016',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000007'),
    ('00000000-0000-4000-a000-000400000017',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000008'),
    ('00000000-0000-4000-a000-000400000018',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000009'),
    ('00000000-0000-4000-a000-000400000019',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000001'),
    ('00000000-0000-4000-a000-000400000020',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000002'),
    ('00000000-0000-4000-a000-000400000021',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000003'),
    ('00000000-0000-4000-a000-000400000022',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000004'),
    ('00000000-0000-4000-a000-000400000023',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000005'),
    ('00000000-0000-4000-a000-000400000024',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000006'),
    ('00000000-0000-4000-a000-000400000025',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000001','00000000-0000-4000-a000-000300000007'),
    ('00000000-0000-4000-a000-000400000026',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000002','00000000-0000-4000-a000-000300000008'),
    ('00000000-0000-4000-a000-000400000027',0,'1970-01-01 00:00:00.000','1970-01-01 00:00:00.000','00000000-0000-4000-a000-000100000003','00000000-0000-4000-a000-000300000009');

  `);
});
